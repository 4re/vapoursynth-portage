From 81294891d0c5d632314c946b654c1278a1d3b70d Mon Sep 17 00:00:00 2001
From: Holy Wu <HolyWu@users.noreply.github.com>
Date: Thu, 28 Jun 2018 09:15:48 +0800
Subject: [PATCH 1/2] configure: Improve handling of LDFLAGS for OpenCL

Closes #5.
---
 Makefile.am  |  4 ++--
 configure.ac | 13 +++++++++----
 2 files changed, 11 insertions(+), 6 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index 3a2b8f6..1c043d5 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -1,5 +1,5 @@
 warning_flags = -Wall -Wextra -Wshadow -Wno-unused-parameter
-common_cflags = -O3 -ffast-math $(warning_flags) $(MFLAGS)
+common_cflags = -O3 -ffast-math -fvisibility=hidden $(warning_flags) $(MFLAGS)
 AM_CXXFLAGS = -std=c++14 $(common_cflags)
 
 AM_CPPFLAGS = $(VapourSynth_CFLAGS)
@@ -28,7 +28,7 @@ libavx_la_SOURCES = TCanny/TCanny_AVX.cpp
 libavx_la_CXXFLAGS = $(AM_CXXFLAGS) -mavx
 
 libavx2_la_SOURCES = TCanny/TCanny_AVX2.cpp
-libavx2_la_CXXFLAGS = $(AM_CXXFLAGS) -mfma -mavx2
+libavx2_la_CXXFLAGS = $(AM_CXXFLAGS) -mavx2 -mfma
 
 libtcanny_la_LIBADD = libavx.la libavx2.la
 endif
diff --git a/configure.ac b/configure.ac
index f99c843..5c43f47 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1,4 +1,4 @@
-AC_INIT([TCanny], [10], [https://github.com/HomeOfVapourSynthEvolution/VapourSynth-TCanny/issues], [TCanny], [https://github.com/HomeOfVapourSynthEvolution/VapourSynth-TCanny/])
+AC_INIT([TCanny], [11], [https://github.com/HomeOfVapourSynthEvolution/VapourSynth-TCanny/issues], [TCanny], [https://github.com/HomeOfVapourSynthEvolution/VapourSynth-TCanny/])
 
 : ${CXXFLAGS=""}
 
@@ -7,12 +7,13 @@ AM_SILENT_RULES([yes])
 
 LT_INIT([disable-static win32-dll])
 
-AC_PROG_CXX
-
 AC_CANONICAL_HOST
 
+AC_PROG_CXX
+
 
 X86="false"
+OPENCLLDFLAGS="-lOpenCL"
 
 AS_CASE(
         [$host_cpu],
@@ -22,6 +23,10 @@ AS_CASE(
 
 AS_CASE(
         [$host_os],
+        [darwin*],
+        [
+         OPENCLLDFLAGS="-framework OpenCL"
+        ],
         [cygwin*|mingw*],
         [
          AS_IF(
@@ -49,7 +54,7 @@ AS_IF(
       [
        AC_DEFINE([HAVE_OPENCL])
 
-       AC_SUBST([OPENCLLDFLAGS], ["-lOpenCL"])
+       AC_SUBST([OPENCLLDFLAGS], ["$OPENCLLDFLAGS"])
       ]
 )
 

From c5d2569b47af116005ca3744d8ab244cee171fef Mon Sep 17 00:00:00 2001
From: Holy Wu <HolyWu@users.noreply.github.com>
Date: Thu, 15 Nov 2018 10:14:21 +0800
Subject: [PATCH 2/2] configure: Fix --disable-opencl

---
 configure.ac | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/configure.ac b/configure.ac
index 5c43f47..a71bedd 100644
--- a/configure.ac
+++ b/configure.ac
@@ -18,7 +18,7 @@ OPENCLLDFLAGS="-lOpenCL"
 AS_CASE(
         [$host_cpu],
         [i?86], [BITS="32" X86="true"],
-        [x86_64], [BITS="64" X86="true"],
+        [x86_64], [BITS="64" X86="true"]
 )
 
 AS_CASE(
@@ -48,13 +48,16 @@ AS_IF(
 )
 
 
-AC_ARG_ENABLE([opencl], AS_HELP_STRING([--enable-opencl], [Enable the TCannyCL filter. (default=yes)]))
+AC_ARG_ENABLE([opencl], AS_HELP_STRING([--enable-opencl], [Enable TCannyCL filter (default=yes)]))
 AS_IF(
       [test "x$enable_opencl" != "xno"],
       [
        AC_DEFINE([HAVE_OPENCL])
 
        AC_SUBST([OPENCLLDFLAGS], ["$OPENCLLDFLAGS"])
+      ],
+      [
+       OPENCLLDFLAGS=
       ]
 )
 
